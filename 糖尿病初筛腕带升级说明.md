# 家用糖尿病初筛腕带升级说明

## 概述
基于现有低RAM优化版MAX30102心率血氧算法（hr_algorithm.cpp）的完整升级方案，针对ESP32-C3 SuperMini（RAM极度受限）的家用糖尿病初筛腕带。

## 升级内容

### 1. SnO₂气敏传感器采集系统
**传感器类型**: MQ-138 或 TGS822（丙酮敏感）
**硬件连接**:
- GPIO5: MOSFET加热控制（高电平加热8秒，每40秒一次）
- GPIO4: AD623放大后ADC输入（RC低通已硬件实现）

**驱动文件**:
- `drivers/sno2_driver.h` - 头文件
- `drivers/sno2_driver.cpp` - 实现文件

**特性**:
- 低RAM优化：使用定点运算（Q10.6格式），无浮点运算
- 非阻塞状态机设计：空闲→加热→采样→计算
- 线性标定接口：`sno2_set_calibration(float a, float b)`
- 加热控制：8秒加热，40秒周期
- 16点ADC采样，中值滤波抗干扰

### 2. 运动干扰校正增强
**算法选择**:
- 一维Kalman滤波（默认）
- TSSD（时间移位差分）artifact去除

**实现文件**:
- `algorithm/motion_correction.h` - 头文件
- `algorithm/motion_correction.cpp` - 实现文件

**特性**:
- 定点运算：Q8.8格式，无浮点
- 双通道滤波：IR和Red通道独立滤波
- 自适应切换：可根据信号质量动态选择算法
- 低计算复杂度：适合ESP32-C3实时处理

### 3. 分时采集主循环框架
**调度策略**:
- MAX30102: 每10ms采样（100Hz）
- SnO₂: 每40秒采样（与加热周期同步）
- 心率计算: 每2秒一次
- SnO₂计算: 每40秒一次（与采样同步）

**实现文件**:
- `system/wrist_scheduler.h` - 头文件
- `system/wrist_scheduler.cpp` - 实现文件

**特性**:
- 非阻塞设计：基于时间戳的任务调度
- 任务标志机制：避免在中断中执行复杂计算
- 统计功能：采样次数、计算次数监控
- 剩余时间查询：便于电源管理

### 4. 心率血氧算法升级
**修改文件**: `algorithm/hr_algorithm.cpp`

**升级内容**:
- 集成运动校正滤波器（Kalman/TSSD）
- 在`hr_algorithm_update()`中应用实时滤波
- 保持原有低RAM优化特性
- 向后兼容现有接口

## RAM使用分析

### 新增RAM占用
1. **SnO₂驱动**:
   - 状态变量: ~20 bytes
   - ADC缓冲区: 16 samples × 2 bytes = 32 bytes
   - 总计: ~52 bytes

2. **运动校正**:
   - Kalman状态: 2通道 × 6 bytes = 12 bytes
   - TSSD状态: 2通道 × (5 samples × 2 + 3) = ~26 bytes
   - 总计: ~38 bytes

3. **调度器**:
   - 状态变量: ~20 bytes
   - 时间戳: 4个 × 4 bytes = 16 bytes
   - 统计: 6个 × 4 bytes = 24 bytes
   - 总计: ~60 bytes

**总增量**: ~150 bytes << 1KB目标

### 保持的优化
- 所有计算使用定点运算（无浮点）
- 缓冲区大小优化（HR_BUFFER_SIZE=64）
- 使用`int16_t`代替`int32_t`（MAX30102数据范围足够）
- 位域结构体节省空间

## 集成步骤

### 步骤1：添加新文件到项目
将以下文件添加到PlatformIO项目：
```
drivers/sno2_driver.h
drivers/sno2_driver.cpp
algorithm/motion_correction.h
algorithm/motion_correction.cpp
system/wrist_scheduler.h
system/wrist_scheduler.cpp
```

### 步骤2：更新现有文件
1. 替换`algorithm/hr_algorithm.cpp`（已包含运动校正）
2. 确保`algorithm/hr_algorithm.h`包含运动校正头文件

### 步骤3：配置引脚
在`config/pin_config.h`中添加SnO₂引脚定义：
```cpp
// SnO₂气敏传感器
#define SNO2_HEATER_PIN      5    // GPIO5 - MOSFET加热控制
#define SNO2_ADC_PIN         4    // GPIO4 - AD623放大后ADC输入
```

### 步骤4：更新主程序
使用`src/main_wrist_upgraded.cpp`作为参考，或按以下方式修改现有主程序：

```cpp
#include "system/wrist_scheduler.h"

void setup() {
    // 初始化串口等
    wrist_scheduler_init();  // 这会初始化所有传感器
}

void loop() {
    // 1. 更新调度器
    wrist_scheduler_update();
    
    // 2. 处理任务
    TaskFlags flags = wrist_scheduler_get_task_flags();
    
    if (flags.hr_sample_due) {
        hr_algorithm_update();
    }
    
    if (flags.hr_calc_due) {
        int status;
        uint8_t bpm = hr_calculate_bpm(&status);
        uint8_t spo2 = hr_calculate_spo2(&status);
        // 处理结果...
    }
    
    if (flags.sno2_sample_due) {
        sno2_update();
    }
    
    if (flags.sno2_calc_due) {
        Sno2Data data = sno2_get_data();
        if (data.valid) {
            // 处理丙酮浓度...
        }
    }
    
    wrist_scheduler_clear_task_flags();
    
    // 3. 其他任务（显示、BLE等）
    delay(1);
}
```

### 步骤5：校准SnO₂传感器
```cpp
// 在setup()中或通过BLE命令设置标定参数
// ppm = a * voltage_mv + b
sno2_set_calibration(0.5, -100);  // 示例参数，需要实际校准
```

## 调试与测试

### 调试输出
启用调试输出查看系统状态：
```cpp
// 在sno2_driver.h和motion_correction.h中启用DEBUG_MODE
#define DEBUG_MODE 1
```

### 测试要点
1. **MAX30102**: 验证心率血氧计算正常
2. **SnO₂加热**: 观察GPIO5输出（8秒高电平，40秒周期）
3. **ADC采样**: 测量GPIO4电压变化
4. **运动校正**: 手动晃动设备，观察信号稳定性
5. **调度时序**: 验证10ms和40秒定时精度

## 电源管理建议

### 低功耗优化
1. **SnO₂加热周期**: 40秒一次，加热时电流较大（~150mA）
2. **采样间隙休眠**: 在任务间隙进入light sleep
3. **动态频率调整**: 根据任务负载调整CPU频率

### 示例代码
```cpp
void enter_light_sleep(uint32_t ms) {
    esp_sleep_enable_timer_wakeup(ms * 1000);
    esp_light_sleep_start();
}

void loop() {
    wrist_scheduler_update();
    
    uint32_t next_event = min(
        wrist_scheduler_get_hr_sample_remaining(),
        wrist_scheduler_get_sno2_sample_remaining()
    );
    
    if (next_event > 10) {  // 至少10ms才休眠
        enter_light_sleep(next_event - 5);  // 提前5ms唤醒
    }
    
    process_scheduler_tasks();
}
```

## 故障排除

### 常见问题
1. **SnO₂无数据**: 检查加热器供电和ADC连接
2. **心率计算失败**: 检查MAX30102连接和信号质量
3. **RAM不足**: 确认使用ESP32-C3（272KB RAM足够）
4. **定时不准**: 检查millis()溢出（约50天）

### 性能监控
使用调度器统计功能监控系统性能：
```cpp
SchedulerStats stats = wrist_scheduler_get_stats();
Serial.printf("HR采样: %lu, SnO2采样: %lu\n", 
              stats.hr_samples, stats.sno2_samples);
```

## 扩展建议

### 未来升级
1. **机器学习**: 添加简单的丙酮浓度分类算法
2. **多传感器融合**: 结合温度、湿度数据
3. **云端同步**: 通过WiFi上传历史数据
4. **用户反馈**: 添加震动/声音提示

### 生产注意事项
1. **传感器校准**: 每台设备需要单独校准SnO₂
2. **EMC测试**: 确保BLE和传感器互不干扰
3. **防水设计**: 腕带需要IP67防水等级
4. **电池寿命**: 优化400mAh电池的续航时间

## 总结
本次升级在保持原有低RAM优化的基础上，完整实现了糖尿病初筛腕带所需的所有功能。总RAM增量控制在150字节以内，远低于1KB目标，适合ESP32-C3 SuperMini等资源受限设备。

所有代码均使用定点运算，无浮点操作，确保实时性和稳定性。分时采集框架实现了高效的资源利用，为后续功能扩展奠定了基础。