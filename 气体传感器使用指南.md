# SnO₂气体传感器驱动使用指南

## 传感器系统概述

基于SnO₂气敏传感器（类似MQ-138，对丙酮敏感）、HKG-07呼吸传感器（数字高电平触发）、AD623仪表运放 + RC低通滤波（1kΩ + 0.1μF，截止≈1.6kHz）、MOSFET加热控制（PWM引脚9），实现呼出气丙酮浓度趋势检测。

## 核心特性

1. **加热控制**：
   - 预热60秒（非阻塞）
   - 加热温度目标350℃
   - PWM占空比可调（预热100%，维持70%）
   - 支持ESP32-C3和Arduino PWM

2. **呼吸触发**：
   - 仅在HKG-07高电平时采集
   - 避免无效数据采集
   - 数字信号抗干扰

3. **ADC采集**：
   - ESP32 12-bit ADC（分辨率4096）
   - 参考电压3.3V（可配置）
   - 采集20个样本进行统计分析

4. **运动干扰处理**：
   - 计算样本方差（mV²）
   - 方差 > 100 mV²判定为运动干扰
   - 运动干扰时使用中值滤波
   - 正常时使用平均值

5. **浓度转换**：
   - 对数模型：ppm = a * ln(Rs/R0) + b
   - 默认参数：a=1.5, b=-2.0
   - Rs计算：Rs = (Vcc - Vout)/Vout * RL（RL=10kΩ）

6. **低功耗设计**：
   - 非阻塞预热判断
   - 仅在呼吸触发时采集
   - 加热功率动态调整

## 文件结构

```
drivers/
├── gas_driver.h    # 驱动头文件（配置参数和接口）
└── gas_driver.cpp  # 驱动实现
```

## 配置参数

### gas_driver.h 中的关键参数

```cpp
// 硬件配置
#define GAS_WARMUP_MS            60000   // SnO₂预热时间（ms）
#define GAS_HEATER_TARGET_TEMP   350     // 目标加热温度（℃）
#define GAS_SAMPLE_COUNT         20      // 采集样本数
#define GAS_VARIANCE_THRESHOLD   100.0f  // 方差阈值（mV²）

// ADC配置
#define GAS_ADC_REF_MV           3300    // 参考电压（mV）
#define GAS_ADC_RESOLUTION       4096    // ADC分辨率（12-bit）

// 电路参数
#define GAS_LOAD_RESISTANCE      10000   // 负载电阻RL（Ω）
#define GAS_SUPPLY_VOLTAGE_MV    3300    // 电源电压Vcc（mV）

// 浓度转换参数（对数模型）
#define GAS_CALIB_A              1.5f    // 参数a
#define GAS_CALIB_B              -2.0f   // 参数b
#define GAS_BASELINE_RESISTANCE  10000.0f // 基准电阻R0（Ω）
```

### pin_config.h 中的引脚定义

```cpp
// 检测模块专用引脚
#define PIN_GAS_ADC     A0  // 气体传感器ADC输入
#define PIN_GAS_HEATER  9   // 加热控制PWM
#define PIN_RESP_TRIG   2   // 呼吸触发信号
```

## 使用示例

### 基本使用流程

```cpp
#include "drivers/gas_driver.h"

void setup() {
    Serial.begin(115200);
    
    // 1. 初始化气体传感器
    if (!gas_init()) {
        Serial.println("气体传感器初始化失败");
        return;
    }
    
    Serial.println("气体传感器初始化完成，开始预热...");
}

void loop() {
    float voltage_mv, conc_ppm;
    
    // 2. 读取数据（非阻塞）
    if (gas_read(&voltage_mv, &conc_ppm)) {
        // 获取加热状态
        float duty_cycle = gas_get_heater_duty_cycle();
        bool is_warmed = gas_is_warmed_up();
        
        Serial.printf("电压: %.1f mV, 浓度: %.2f ppm\n", voltage_mv, conc_ppm);
        Serial.printf("加热占空比: %.0f%%, 预热完成: %s\n", 
                      duty_cycle, is_warmed ? "是" : "否");
        
        // 浓度趋势分析
        if (conc_ppm > 10.0) {
            Serial.println("注意：丙酮浓度偏高（趋势分析）");
        }
    } else {
        // 检查预热状态
        if (!gas_is_warmed_up()) {
            static uint32_t last_check = 0;
            if (millis() - last_check > 5000) {
                last_check = millis();
                float elapsed = (millis() - warmup_start) / 1000.0;
                Serial.printf("预热中... %.0f/60秒\n", elapsed);
            }
        }
    }
    
    delay(100);  // 主循环延迟
}
```

### 集成到系统调度器

```cpp
#include "system/scheduler.h"
#include "drivers/gas_driver.h"

// 气体采集任务
void gas_task_function() {
    static uint32_t last_measurement = 0;
    uint32_t now = millis();
    
    // 每100ms检查一次呼吸触发
    if (now - last_measurement >= 100) {
        last_measurement = now;
        
        float voltage_mv, conc_ppm;
        if (gas_read(&voltage_mv, &conc_ppm)) {
            // 更新系统状态
            system_state_set_gas_voltage(voltage_mv);
            system_state_set_acetone_ppm(conc_ppm);
            
            // 记录数据
            data_logger_add_gas_sample(voltage_mv, conc_ppm);
        }
    }
}

// 初始化任务
SchedulerTask gas_task = {
    .interval_ms = 100,
    .last_run_ms = 0,
    .function = gas_task_function
};
```

## 算法原理

### 1. 加热控制算法

```cpp
// 预热阶段（0-60秒）
heater_duty_cycle = 100%;  // 全功率加热

// 恒温阶段（60秒后）
heater_duty_cycle = 70%;   // 维持350℃

// 温度调节（简化PID）
if (estimated_temp < GAS_HEATER_TARGET_TEMP - 10) {
    duty_cycle += 10;
} else if (estimated_temp > GAS_HEATER_TARGET_TEMP + 10) {
    duty_cycle -= 10;
}
```

### 2. 运动干扰检测

```cpp
// 采集20个样本
for (i = 0; i < 20; i++) {
    samples[i] = read_adc();
    delay(5ms);
}

// 计算方差
variance = 0;
mean = average(samples);
for (i = 0; i < 20; i++) {
    diff = samples[i] - mean;
    variance += diff * diff;
}
variance /= 19;  // n-1

// 判断运动干扰
if (variance > 100 mV²) {
    // 使用中值滤波
    processed = median_filter(samples);
} else {
    // 使用平均值
    processed = mean;
}
```

### 3. 浓度转换模型

```cpp
// 1. 计算传感器电阻
// Rs = (Vcc - Vout) / Vout * RL
float rs = ((3.3 - vout) / vout) * 10000;

// 2. 计算电阻比
// ratio = Rs / R0
float ratio = rs / 10000.0;

// 3. 对数模型转换
// ppm = a * ln(ratio) + b
float ppm = 1.5 * log(ratio) - 2.0;

// 4. 限制有效范围
if (ppm < 0) ppm = 0;
```

## 校准指南

### 1. 基准电阻R0校准

```cpp
// 在清洁空气中测量
// 1. 预热传感器60秒
// 2. 采集稳定电压V0
// 3. 计算R0
//    R0 = (Vcc - V0) / V0 * RL

#define GAS_BASELINE_RESISTANCE  15000.0f  // 实测值，替换默认10000
```

### 2. 对数模型参数校准

```cpp
// 使用已知浓度气体校准
// 浓度1: 10ppm, 电阻R1
// 浓度2: 50ppm, 电阻R2

// 计算参数a,b
// a = (ppm2 - ppm1) / ln(R2/R1)
// b = ppm1 - a * ln(R1/R0)

#define GAS_CALIB_A              2.1f     // 实测值
#define GAS_CALIB_B              -3.5f    // 实测值
```

### 3. 方差阈值调整

```cpp
// 根据实际运动干扰程度调整
// 静置状态方差：~10-50 mV²
// 轻微运动方差：~50-100 mV²
// 明显运动方差：>100 mV²

#define GAS_VARIANCE_THRESHOLD   150.0f   // 提高阈值减少误判
// 或
#define GAS_VARIANCE_THRESHOLD   80.0f    // 降低阈值提高灵敏度
```

## 硬件连接

### 电路原理图

```
SnO₂传感器 → AD623运放 → RC低通滤波 → ADC引脚
      ↑              ↑
  加热控制       参考电压
   (PWM9)        (1.65V)
```

### 引脚连接表

| 引脚 | 功能 | 连接 |
|------|------|------|
| A0   | ADC输入 | AD623输出 |
| 9    | PWM加热 | MOSFET栅极 |
| 2    | 呼吸触发 | HKG-07输出 |
| 3.3V | 电源 | 传感器Vcc |
| GND  | 地线 | 公共地 |

### RC滤波计算

```
截止频率 fc = 1/(2πRC)
R = 1kΩ, C = 0.1μF
fc = 1/(2π×1000×0.1×10^-6) ≈ 1.6kHz
```

## 调试与测试

### 1. 调试输出

```cpp
// 在gas_driver.cpp中添加调试输出
#ifdef GAS_DEBUG
    Serial.printf("[GAS] 采样方差: %.1f mV²\n", variance);
    Serial.printf("[GAS] 使用%s滤波\n", 
                  variance > GAS_VARIANCE_THRESHOLD ? "中值" : "平均");
    Serial.printf("[GAS] 电压: %.1f mV, 电阻: %.0f Ω\n", voltage_mv, rs);
    Serial.printf("[GAS] 浓度: %.2f ppm\n", conc_ppm);
#endif
```

### 2. 测试流程

```cpp
void test_gas_sensor() {
    // 1. 初始化测试
    gas_init();
    
    // 2. 预热测试
    uint32_t start = millis();
    while (!gas_is_warmed_up()) {
        float elapsed = (millis() - start) / 1000.0;
        Serial.printf("预热: %.1f/60.0秒\n", elapsed);
        delay(1000);
    }
    
    // 3. 采集测试
    for (int i = 0; i < 10; i++) {
        float voltage, ppm;
        if (gas_read(&voltage, &ppm)) {
            Serial.printf("测试%d: %.1f mV, %.2f ppm\n", i+1, voltage, ppm);
        } else {
            Serial.printf("测试%d: 无呼吸触发\n", i+1);
        }
        delay(2000);
    }
}
```

### 3. 性能指标

| 指标 | 值 | 说明 |
|------|-----|------|
| 预热时间 | 60秒 | 达到稳定工作温度 |
| 采样间隔 | 100ms | 呼吸触发检测频率 |
| 采集时间 | 100ms | 20个样本×5ms |
| 计算时间 | <1ms | 方差计算+滤波+转换 |
| 功耗（加热） | ~500mA | 100%占空比时 |
| 功耗（维持） | ~350mA | 70%占空比时 |

## 故障排除

### 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 无电压输出 | 传感器未加热 | 检查PWM引脚和MOSFET |
| 电压始终为0 | ADC引脚错误 | 检查PIN_GAS_ADC定义 |
| 浓度计算为0 | R0值错误 | 重新校准基准电阻 |
| 方差始终很大 | 电路噪声 | 检查电源滤波和接地 |
| 无呼吸触发 | HKG-07连接错误 | 检查PIN_RESP_TRIG引脚 |

### 信号质量评估

```cpp
// 评估信号质量
void evaluate_signal_quality() {
    float voltage, ppm;
    if (gas_read(&voltage, &ppm)) {
        // 正常范围检查
        if (voltage < 100 || voltage > 3000) {
            Serial.println("警告：电压超出正常范围");
        }
        
        // 稳定性检查
        static float last_voltage = 0;
        float change = abs(voltage - last_voltage);
        if (change > 500) {  // 500mV突变
            Serial.println("警告：电压突变，可能干扰");
        }
        last_voltage = voltage;
    }
}
```

## 安全注意事项

1. **加热安全**：
   - 传感器表面温度可达350℃
   - 避免接触皮肤
   - 确保通风良好

2. **电气安全**：
   - 最大加热电流500mA
   - 使用合适规格的MOSFET
   - 添加过流保护

3. **数据安全**：
   - 浓度数据仅用于趋势分析
   - 不用于医疗诊断
   - 输出包含免责声明

## 扩展开发

### 1. 添加温度补偿

```cpp
// 读取温度传感器
float temp = read_temperature();

// 温度补偿公式
// Rs_corrected = Rs / (1 + α*(T - T0))
float alpha = 0.003;  // 温度系数
float t0 = 25.0;      // 参考温度
float rs_corrected = rs / (1 + alpha * (temp - t0));
```

### 2. 自适应加热控制

```cpp
// 根据环境温度调整加热
float env_temp = read_environment_temp();
if (env_temp < 20) {
    heater_duty_cycle = 80;  // 低温环境增加加热
} else if (env_temp > 30) {
    heater_duty_cycle = 60;  // 高温环境减少加热
}
```

### 3. 多传感器融合

```cpp
// 结合心率数据提高准确性
float hr = get_heart_rate();
float resp_rate = get_respiration_rate();

// 运动状态判断
bool is_moving = (hr > 100) || (resp_rate > 25);
if (is_moving) {
    // 运动状态下提高方差阈值
    variance_threshold = 200.0f;
}
```

## 版本历史

- v1.0 (2026-01-26): 初始版本
  - 加热控制（PWM，预热60秒）
  - 呼吸触发采集
  - 运动干扰检测（方差分析）
  - 中值滤波/平均值选择
  - 对数浓度转换模型

## 技术支持

如有问题，请参考：
1. SnO₂传感器数据手册
2. AD623运放数据手册
3. HKG-07呼吸传感器说明
4. 电路原理图和PCB设计

---

**重要声明**：本驱动实现仅供参考，不用于医疗诊断。实际使用前请进行充分测试和校准。