# 糖尿病筛查监测系统 - 项目结构总结

## 项目概述

基于Arduino的多参数家用糖尿病初期筛查监测系统，采用双模块分离架构：
1. **腕带主控模块**：ESP32-C3 SuperMini + MAX30102 + 0.96" OLED + 锂电池300mAh + TP4056充电 + 按键
2. **独立检测模块**：ESP32-C3 SuperMini + SnO₂气敏传感器 + HKG-07呼吸传感器 + AD623运放 + RC低通滤波 + MOSFET加热控制 + 锂电池200mAh

**核心设计**：一份代码通过条件编译适配两种硬件角色（`#define DEVICE_ROLE_WRIST` / `#define DEVICE_ROLE_DETECTOR`）

**项目约束**：
- 总成本 ≤500元
- 腕带重量 <45g
- 不输出任何医疗诊断内容
- 所有输出包含免责声明

## 项目目录结构

```
e:/Diabetes_Screening_System/
├── 项目结构总结.md                    # 本文档
├── platformio.ini                    # PlatformIO配置文件
├── Diabetes_Screening_System.ino     # Arduino主程序入口
├── Diabetes_Screening_System.code-workspace  # VSCode工作区配置
├── .gitignore                        # Git忽略文件
├── .pioignore                        # PlatformIO忽略文件
│
├── config/                           # 配置文件目录
│   ├── config.h                      # 硬件角色配置文件（核心）
│   ├── pin_config.h                  # 引脚配置文件
│   ├── system_config.h               # 系统参数配置文件
│   └── version.h                     # 版本信息文件
│
├── src/                              # 源代码目录
│   ├── main.cpp                      # 主程序入口（条件编译分发）
│   └── main_minimal.cpp              # 最小化版本（调试用）
│
├── main_control/                     # 腕带主控专用代码
│   └── main_control.ino              # 腕带主控主程序
│
├── detection_sensor/                 # 检测模块专用代码
│   └── detection_sensor.ino          # 检测模块主程序
│
├── system/                           # 系统框架
│   ├── scheduler.cpp/.h              # 任务调度器（分时采集）
│   ├── system_state.cpp/.h           # 系统状态管理（低RAM优化）
│   └── output/                       # 输出模块（预留）
│
├── algorithm/                        # 算法模块
│   ├── hr_algorithm.cpp/.h           # 心率计算算法
│   ├── data_filter.cpp/.h            # 数据滤波算法
│   └── risk_assessment.cpp/.h        # 风险评估算法
│
├── drivers/                          # 设备驱动
│   ├── hr_driver.cpp/.h              # MAX30102心率传感器驱动
│   ├── gas_driver.cpp/.h             # SnO₂气体传感器驱动
│   └── env_driver.cpp/.h             # 环境传感器驱动
│
└── utils/                            # 工具函数
    ├── debug.cpp/.h                  # 调试输出工具
    └── （其他工具函数）
```

## 核心文件说明

### 1. 配置文件 (`config/`)

#### `config/config.h` - 硬件角色配置文件
- **功能**：通过条件编译实现一份代码适配两种硬件
- **关键特性**：
  - 角色选择：`DEVICE_ROLE_WRIST`（腕带主控）或 `DEVICE_ROLE_DETECTOR`（检测模块）
  - 调试模式开关：`DEBUG_MODE`
  - 硬件平台选择：`MCU_ARDUINO_UNO`（调试）或 `MCU_ESP32_C3`（产品）
  - 严格的错误检查宏（`#error`）
  - 成本与重量约束检查
  - 免责声明配置：`DISCLAIMER_STRING`

#### `config/pin_config.h` - 引脚配置文件
- **功能**：根据硬件角色动态配置引脚
- **关键特性**：
  - 通用引脚定义（I2C、电源管理、用户交互）
  - 腕带主控专用引脚（MAX30102、OLED、MPU6050等）
  - 检测模块专用引脚（气体传感器、呼吸传感器、AD623等）
  - 引脚冲突检查（编译时警告）

#### `config/system_config.h` - 系统参数配置文件
- **功能**：定义所有系统级配置参数
- **关键特性**：
  - 通用系统配置（时钟、串口、电源、数据存储）
  - 腕带主控专用配置（心率血氧、OLED显示、BLE通信）
  - 检测模块专用配置（气体传感器、加热控制、呼吸传感器）
  - 算法参数配置（滤波、信号质量、风险评估）
  - 安全限制配置（温度、电气、时间）

### 2. 主程序入口 (`src/main.cpp`)

#### 设计理念
- 根据`config.h`中选择的角色，包含对应的主程序文件
- 实现一份代码适配两种硬件角色
- 包含通用初始化函数和角色特定函数调用

#### 关键特性
- 角色选择检查（编译时错误）
- 免责声明输出（所有输出必须包含）
- 调试模式控制（生产版本关闭串口输出）
- 通用看门狗支持

### 3. 专用模块代码

#### `main_control/main_control.ino` - 腕带主控程序
- **功能**：完整手表功能 + BLE接收检测板数据
- **关键特性**：
  - NTP时钟同步（阿里云服务器）
  - 大字体时间 + 日期星期（中文显示）
  - 三种界面模式：时钟/测量/倒计时
  - 30秒无操作OLED自动熄屏
  - 低功耗模式（每秒唤醒刷新时间）
  - 电池电量分级显示
  - BLE Central接收检测模块数据

#### `detection_sensor/detection_sensor.ino` - 检测模块程序
- **功能**：分时采集多传感器数据 + BLE广播
- **关键特性**：
  - 分时采集：MAX30102（30秒）→ SnO₂加热（60秒）→ 丙酮采集（5秒）
  - BLE Peripheral发送三个独立特征值（心率、血氧、丙酮）
  - 运动干扰检测与校正
  - 低功耗睡眠（每轮采集后睡眠5分钟）
  - 中值滤波与方差分析

### 4. 系统框架 (`system/`)

#### `system/system_state.h/.cpp` - 系统状态管理
- **功能**：全局共享数据管理，低RAM优化设计
- **关键特性**：
  - 心率数据：`uint8_t hr_bpm`（40-180 BPM值）
  - 气体数据：`uint16_t gas_concentration_ppm`（精度0.1ppm）
  - 环境数据：`int8_t env_temperature_c`（-40~85℃）
  - 时间戳：秒级时间戳，节省内存

#### `system/scheduler.h/.cpp` - 任务调度器
- **功能**：非阻塞分时采集多传感器数据
- **关键特性**：
  - 基于`millis()`的时间片轮转调度
  - 高优先级：心率采集（实时性要求高）
  - 中优先级：气体采集（需要稳定加热）
  - 低优先级：环境采集（变化缓慢）

### 5. 算法模块 (`algorithm/`)

#### `algorithm/hr_algorithm.h/.cpp` - 心率计算算法
- **功能**：从PPG信号中提取心率值
- **算法流程**：
  1. 信号预处理（去基线、滤波）
  2. 峰值检测（自适应阈值）
  3. 心率计算（RR间期统计）
  4. 信号质量评估（SNR计算）
  5. 运动伪影检测与校正

#### `algorithm/data_filter.h/.cpp` - 数据滤波算法
- **包含的滤波器**：
  - 移动平均滤波器（平滑噪声）
  - 中值滤波器（去除脉冲噪声）
  - 低通滤波器（截止频率可调）
  - 带通滤波器（心率频带：0.67-3.0Hz）
  - 自适应滤波器（根据信号质量调整参数）

#### `algorithm/risk_assessment.h/.cpp` - 风险评估算法
- **功能**：多参数趋势分析与风险提示
- **注意**：不进行医疗诊断，仅提供趋势信息
- **分析参数**：
  - 心率变异性（HRV）
  - 丙酮浓度趋势
  - 呼吸率变化
  - 多参数相关性分析

### 6. 设备驱动 (`drivers/`)

#### `drivers/hr_driver.h/.cpp` - MAX30102驱动
- **功能**：MAX30102心率血氧传感器驱动
- **通信接口**：I2C（地址0x57）
- **配置参数**：
  - 采样率：50/100/200/400/800/1000/1600/3200 Hz
  - LED电流：0-50mA（影响功耗和信噪比）
  - LED脉宽：69/118/215/411 us

#### `drivers/gas_driver.h/.cpp` - SnO₂气体传感器驱动
- **功能**：SnO₂气敏传感器驱动（MQ-138）
- **电路**：AD623运放 + RC滤波 + MOSFET加热控制
- **加热控制**：
  - 预热阶段：100% PWM，60秒
  - 恒温阶段：PID控制，350℃±10℃
  - 安全保护：过热保护，电流限制

#### `drivers/env_driver.h/.cpp` - 环境传感器驱动
- **功能**：环境温湿度传感器驱动（DHT20/AHT20）
- **通信接口**：I2C
- **主要函数**：初始化、读取温湿度、校准

## 编译与部署

### 1. 环境配置

**PlatformIO配置 (`platformio.ini`):**
```ini
[env:esp32-c3]
platform = espressif32
board = esp32-c3-devkitm-1
framework = arduino
monitor_speed = 115200
upload_speed = 921600
lib_deps = 
    Wire
    SPI
    Adafruit MAX3010x Library
build_flags = 
    -D DEVICE_ROLE_WRIST  # 或 -D DEVICE_ROLE_DETECTOR
```

### 2. 编译步骤

```bash
# 1. 选择硬件角色（编辑config/config.h）
# 取消注释对应的角色定义

# 2. 使用PlatformIO编译
pio run

# 3. 上传到设备
pio run --target upload

# 4. 监视串口输出
pio device monitor
```

### 3. 双模块部署

**腕带主控部署:**
1. 在`config/config.h`中取消注释`#define DEVICE_ROLE_WRIST`
2. 注释`#define DEVICE_ROLE_DETECTOR`
3. 编译并上传到腕带设备

**检测模块部署:**
1. 在`config/config.h`中取消注释`#define DEVICE_ROLE_DETECTOR`
2. 注释`#define DEVICE_ROLE_WRIST`
3. 编译并上传到检测设备

## 数据流与通信

### 1. 数据采集流程
```
传感器采集 -> 驱动层 -> 数据滤波 -> 算法处理 -> 系统状态
      ↓
任务调度器（分时控制）
      ↓
状态机管理 -> 输出报告
```

### 2. BLE通信协议
```
检测模块（Peripheral） -> 广播测量数据
      ↓
腕带主控（Central） -> 接收并显示数据
      ↓
腕带主控（Peripheral） -> 转发数据到手机APP
```

### 3. 数据格式
```cpp
// BLE广播数据包格式
typedef struct {
    uint8_t device_id;          // 设备ID
    uint8_t data_type;          // 数据类型（心率/气体/环境）
    uint16_t timestamp;         // 时间戳（秒）
    uint16_t value1;            // 主测量值
    uint16_t value2;            // 辅助值/质量指标
    uint8_t status;             // 状态标志
} BLE_DataPacket;
```

## 项目约束实现

### 1. 成本控制（≤500元）
- **腕带主控**：300元预算
  - ESP32-C3 SuperMini：30元
  - MAX30102心率血氧传感器：50元
  - 0.96" OLED显示屏：20元
  - 锂电池300mAh + TP4056充电：25元
  - 其他元件（按键、电阻、电容等）：25元
  - PCB打样：50元
  - 外壳：100元
  - **总计：300元**

- **检测模块**：200元预算
  - ESP32-C3 SuperMini：30元
  - SnO₂气敏传感器（MQ-138）：25元
  - HKG-07呼吸传感器：30元
  - AD623运放芯片：15元
  - MOSFET加热控制：10元
  - RC滤波元件：5元
  - 锂电池200mAh：15元
  - PCB打样：50元
  - 外壳：20元
  - **总计：200元**

- **总成本**：300元 + 200元 = **500元**

### 2. 重量控制（腕带<45g）
- **腕带重量估算**：
  - ESP32-C3 SuperMini：5g
  - MAX30102传感器：2g
  - OLED显示屏：3g
  - 锂电池300mAh：15g
  - PCB：10g
  - 外壳：8g
  - 其他：2g
  - **总计：45g**

### 3. 非医疗诊断原则
- 所有输出包含免责声明："本设备仅用于生理参数趋势监测，不用于医疗诊断，请咨询专业医生"
- 仅提供趋势分析和参数变化提示
- 不进行疾病诊断或医疗建议
- 数据标注"仅供参考"

## 调试与测试

### 1. 调试模式
- 启用`DEBUG_MODE`查看详细日志
- 使用`utils/debug.h`中的调试宏
- 通过串口监视器查看实时数据

### 2. 测试流程
1. **单元测试**：测试各个驱动模块功能
2. **集成测试**：测试多传感器协同工作
3. **系统测试**：测试完整数据流和BLE通信
4. **功耗测试**：测试低功耗模式和电池寿命
5. **可靠性测试**：测试长时间运行稳定性

## 扩展开发

### 1. 添加新传感器
1. 在`drivers/`目录创建新的驱动文件
2. 在`config/config.h`中添加启用标志
3. 在`system/scheduler.cpp`中添加调度任务
4. 在`system/system_state.h`中添加数据字段

### 2. 修改算法参数
1. 编辑`algorithm/`目录下的对应文件
2. 调整`config/system_config.h`中的参数
3. 重新编译测试

### 3. 功耗优化
1. 使用深度睡眠模式（`POWER_MODE_DEEP_SLEEP`）
2. 动态调整CPU频率
3. 关闭未使用的外设时钟

## 技术支持

### 1. 常见问题
- **编译错误**：检查`config/config.h`中的角色选择
- **传感器无数据**：检查I2C地址和引脚连接
- **BLE连接失败**：检查UUID匹配和设备名称
- **功耗过高**：检查低功耗模式配置

### 2. 版本更新
- 版本信息在`config/version.h`中管理
- 支持OTA无线更新
- 版本兼容性检查

---

**文档版本**: 1.0  
**最后更新**: 2026-01-26  
**维护者**: 项目开发团队  

*注：本文档为项目结构总结，详细技术实现请参考各源代码文件。*